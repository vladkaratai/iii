<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C - Twilio Client</title>
  <!-- –£–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã -->
<script src="https://sdk.twilio.com/js/client/v1.15/twilio.min.js"></script>
</head>
<body>
  <h2>üìû C ‚Äî –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–≤–æ–Ω–∫–∏</h2>
  <button id="init">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å C (–Ω–∞–∂–º–∏ —Å–Ω–∞—á–∞–ª–∞)</button>
  <button id="answer" disabled>üìû –ü–æ–¥–Ω—è—Ç—å —Ç—Ä—É–±–∫—É</button>
  <button id="reject" disabled>‚ùå –°–±—Ä–æ—Å–∏—Ç—å</button>

  <script>
  let device = null;
  let pendingConn = null;

  async function initDevice() {
    try {
      // 1) –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω (–≤ user gesture)
      await navigator.mediaDevices.getUserMedia({ audio: true }).catch(err => {
        console.warn('getUserMedia warning:', err);
        // –Ω–µ –±—Ä–æ—Å–∞–µ–º ‚Äî –Ω–æ —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è
      });

      const res = await fetch('https://burndial-twilio-cron.onrender.com/token-c?creator_id=C');
      const data = await res.json();

      const token = data.token || data; // –µ—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ {token:...}

      if (!token) throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω');

      // debug:true –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ
      device = new Twilio.Device(token, { debug: true, codecPreferences: ['opus', 'pcmu'] });

      device.on('ready', () => {
        console.log('‚úÖ Twilio.Device ready/registered');
        document.getElementById('answer').disabled = false;
        document.getElementById('reject').disabled = false;
      });

      device.on('offline', () => console.log('‚ö†Ô∏è Device offline'));
      device.on('error', err => console.error('‚ùå Client error:', err));
      device.on('connect', conn => console.log('üîó Connected (device.connect) ‚Äî', conn));
      device.on('disconnect', conn => console.log('‚õî Disconnected', conn));

      device.on('incoming', conn => {
        console.log('üìû incoming connection:', conn);
        pendingConn = conn;

        // –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        try { console.log('incoming parameters:', conn.parameters); } catch (e) {}

        document.getElementById('answer').onclick = async () => {
          try {
            console.log('‚úÖ Accepting incoming call...');
            conn.accept(); // user gesture
          } catch (e) { console.error('accept error', e); }
        };

        document.getElementById('reject').onclick = () => {
          console.log('‚ùå Rejecting incoming call');
          conn.reject();
        };

        // –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤–Ω—É—Ç—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        conn.on('accept', () => console.log('connection accepted (event)'));
        conn.on('cancel', () => console.log('connection cancelled'));
        conn.on('disconnect', () => console.log('connection disconnected'));
        conn.on('error', e => console.error('connection error', e));
      });

      // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–∂–Ω–∞)
      try { device.register(); } catch (e) { console.warn('device.register() warning:', e); }

      document.getElementById('init').disabled = true;
      document.getElementById('init').textContent = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
    } catch (err) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
      alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (err.message || err));
    }
  }

  document.getElementById('init').onclick = initDevice;
</script>

</body>
</html>
