<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C - Twilio Voice (v2)</title>
  <!-- –ù–û–í–´–ô SDK -->
<script src="https://media.twiliocdn.com/sdk/js/voice/releases/2.4.0/twilio.min.js"></script>
</head>
<body>
  <h2>üìû C ‚Äî –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–≤–æ–Ω–∫–∏ (Voice SDK v2)</h2>
  <button id="init">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å C (–Ω–∞–∂–º–∏ —Å–Ω–∞—á–∞–ª–∞)</button>
  <button id="answer" disabled>üìû –ü–æ–¥–Ω—è—Ç—å —Ç—Ä—É–±–∫—É</button>
  <button id="reject" disabled>‚ùå –°–±—Ä–æ—Å–∏—Ç—å</button>

  <script>
    let device = null;
    let pendingCall = null;

    async function initDevice() {
      try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ user gesture)
        await navigator.mediaDevices.getUserMedia({ audio: true });

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
        const res = await fetch('https://burndial-twilio-cron.onrender.com/token-c?creator_id=C');
        if (!res.ok) throw new Error(`Token fetch failed: ${res.status}`);
        const data = await res.json();
        const token = data.token?.trim();
        if (!token) throw new Error('Token is missing or empty');

        // –°–æ–∑–¥–∞—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
      device = new TwilioVoice.Device(token, {
  codecPreferences: ['opus', 'pcmu'],
  logLevel: 'debug',
});


        // –°–æ–±—ã—Ç–∏—è
        device.on('registered', () => {
          console.log('‚úÖ Device registered (ready to receive calls)');
          document.getElementById('answer').disabled = false;
          document.getElementById('reject').disabled = false;
        });

        device.on('error', error => {
          console.error('‚ùå Device error:', error);
          alert('Device error: ' + error.message);
        });

        device.on('incoming', call => {
          console.log('üìû Incoming call:', call);
          pendingCall = call;

          // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –∫–Ω–æ–ø–∫–∞–º
          document.getElementById('answer').onclick = () => {
            console.log('‚úÖ Accepting call...');
            call.accept();
          };

          document.getElementById('reject').onclick = () => {
            console.log('‚ùå Rejecting call');
            call.reject();
          };

          // –°–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
          call.on('accept', () => console.log('‚úÖ Call accepted'));
          call.on('disconnect', () => {
            console.log('üìû Call disconnected');
            pendingCall = null;
          });
          call.on('error', error => console.error('üìû Call error:', error));
        });

        // –†–ï–ì–ò–°–¢–†–ò–†–£–ï–ú —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ v2!)
        await device.register();

        document.getElementById('init').disabled = true;
        document.getElementById('init').textContent = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
      } catch (err) {
        console.error('‚ùå Initialization failed:', err);
        alert('–û—à–∏–±–∫–∞: ' + (err.message || err));
      }
    }

    document.getElementById('init').onclick = initDevice;
  </script>
</body>
</html>
